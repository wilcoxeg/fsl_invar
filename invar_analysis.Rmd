---
title: "Initial Analysis for Few Shot Learning"
output:
  pdf_document:
    latex_engine: xelatex
---

```{r}
library(tidyverse)
library(brms)
library(lme4)
library(lmerTest)
library(plotrix)
library(stringr)
library(readxl)
library(RColorBrewer)
library(Hmisc)
```


# Verbal Argument Structure

Read in the data. Verb argument structure status (transitive, ambitransitive, intransitive) comes from CELEX2, distributed by the LDC.

```{r}

d_agg = read.csv("argstruct_data.csv") %>%
  mutate(vb_freq = as.factor(vb_freq),
         vbd_freq = as.factor(vbd_freq),
         total_freq = as.factor(total_freq)) %>%
  mutate(model = factor(model, levels = c("5gram", "lstm", "actionLstm", "rnng")))


```


## Base Context Few Shot Learning

### Tests

The Object Expectation is the surprisal in the no-obj condition minus the surprisal in the obj condition. Positive means the model expects an object after the verb

**Base-Past**

  • The lion devoured the gazelle today . [obj]
  
  • The lion devoured today . [no-obj]
  
**Base-Pres**

  • The lion can devour the gazelle today . [obj]
  
  • The lion can devour today . [no-obj]
  
We measure the surprisal in the "yesterday ." portion of the sentence

Predictions: 

  (1) The object expectation for transitive should be greater than for intransitive verbs.
  
  (2) The object expectation should be positive for transitive verbs (an object should be expected)
  
  (3) The object expectation should be negative for intransitive verbs (no object should be expected)
  
  (4) Ambitransitive verbs should be in between transitive and intransitive

### Results

Plot the object expectation for transitive, intransitive and ambitransitive verbs against their frequency in active contexts (vbn_freq) in the corpus.

#### Base-Present

We see a couple of things:

NGram:

• The transitive verbs are not significantly above the intransitive verbs.

• There is a main effect of verb frequency. As the verb becomes more frequent, the model expects no object regardless of whether it's a transitive or intransitive verb.

LSTM:

• The transitive verbs show more object expectation than the intransitive verbs, except for 2 and 20 exposures.

• No increase in object expectation.

```{r}
d_agg %>%
  filter(vb_freq == "2" | vb_freq == "3" | vb_freq == "5" | vb_freq == "10" | vb_freq == "20" | vb_freq == "30") %>%
  filter(test == "base-pres" & is_trans != "Ambitrans") %>%
  
  group_by(model, is_trans, test, vb_freq) %>%
    summarise(m = mean(obj_exp),
              s=std.error(obj_exp),
              upper=m+1.96*s,
              lower=m-1.96*s)%>%
  ungroup() %>%
  
  ggplot(aes(x=vb_freq, y=m, ymin=lower, ymax=upper, color=is_trans)) +
    geom_point(stat="identity", position="dodge", size=2) +
    geom_errorbar(width=.2, alpha=0.8) +
    geom_hline(yintercept=0, color="blue", alpha=0.5) +
    ylab("Object Expectation") +
    xlab("Frequency") +
    ggtitle("Argument Structure: Active, Present") +
    facet_grid(~model) +
    theme(axis.title.x=element_blank(),
          legend.position = "none")
ggsave("./images/argstruct-pres.png",height=2,width=6)

```

### Positive Predictions

```{r}
d_agg %>%
  filter(vb_freq == "2" | vb_freq == "3" | vb_freq == "5" | vb_freq == "10" | vb_freq == "20" | vb_freq == "30") %>%
  filter(test == "base-pres",  is_trans != "Ambitrans") %>%
  
  mutate(obj_exp = if_else(obj_exp > 0, 1, 0)) %>%
  mutate(obj_exp = if_else(is_trans == "Intrans", 1-obj_exp, obj_exp)) %>%
  
  group_by(model, test, vb_freq) %>%
    summarise(m = mean(obj_exp),
              s=std.error(obj_exp),
              upper=m+1.96*s,
              lower=m-1.96*s)%>%
  ungroup() %>%
  ggplot(aes(x=vb_freq, y=m, ymin=lower, ymax=upper, fill=model)) +
    geom_bar(stat="identity", position="dodge", size=3) +
    geom_errorbar(position=position_dodge(width=0.9), width=.2, alpha=0.8) +
    geom_hline(yintercept=0.5, color="blue", alpha=0.5) +
    ylab("Obj Exp. Accuracy") +
    xlab("Frequency") +
    #ggtitle("Base Non-Tensed") +
    facet_grid(~model) +
    ylim(0,1) +
    scale_fill_brewer(palette="PRGn") +
    theme(axis.text=element_text(size=10),
          legend.position = "none")
ggsave("./images/argstruct-pres-acc.png",height=1.5,width=6)

```

#### Base-Past

NGram:

• The intransitive verbs show higher object expectation than the transitive verbs. (This is odd..)

• There is a main effect of verb frequency. As the verb becomes more frequent, the model expects no object regardless of whether it's a transitive or intransitive verb.

LSTM:

• The transitive verbs show more object expectation than the intransitive verbs, except for 30 exposures.



```{r}
d_agg %>%
  filter(test == "base-nomod" & is_trans != "Ambitrans") %>%
  filter(vbd_freq == "2" | vbd_freq == "3" | vbd_freq == "5" | vbd_freq == "10" | vbd_freq == "20" | vbd_freq == "30") %>%

  group_by(model, is_trans, test, vbd_freq) %>%
    summarise(m = mean(obj_exp),
              s=std.error(obj_exp),
              upper=m+1.96*s,
              lower=m-1.96*s)%>%
  ungroup() %>%
  ggplot(aes(x=vbd_freq, y=m, ymin=lower, ymax=upper, color=is_trans)) +
    geom_point(stat="identity", position="dodge", size=2) +
    geom_errorbar(width=.2, alpha=0.8) +
    geom_hline(yintercept=0, color="blue", alpha=0.5) +
    ylab("Object Expectation") +
    xlab("Frequency") +
    ggtitle("Argument Structure: Active, Past") +
    facet_grid(~model) +
    theme(axis.title.x=element_blank(),
          legend.position = "none")
ggsave("./images/argstruct-base.png",height=2,width=6)

```

## Accuracy Metric
```{r}

d_agg %>%
  filter(test == "base-nomod", is_trans != "Ambitrans") %>%
  filter(vbd_freq == "2" | vbd_freq == "3" | vbd_freq == "5" | vbd_freq == "10" | vbd_freq == "20" | vbd_freq == "30") %>%
  filter(VBD_obj < 0.1 | VBD_obj > 0.9) %>%
  
  mutate(obj_exp = if_else(obj_exp > 0, 1, 0)) %>%
  mutate(obj_exp = if_else(is_trans == "Intrans", 1-obj_exp, obj_exp)) %>%
  
  group_by(model, test, vbd_freq) %>%
    summarise(m = mean(obj_exp),
              s=std.error(obj_exp),
              upper=m+1.96*s,
              lower=m-1.96*s)%>%
  ungroup() %>%
  ggplot(aes(x=vbd_freq, y=m, ymin=lower, ymax=upper, fill=model)) +
    geom_bar(stat="identity", position="dodge", size=3) +
    geom_errorbar(position=position_dodge(width=0.9), width=.2, alpha=0.8) +
    geom_hline(yintercept=0.5, color="blue", alpha=0.5) +
    ylab("Obj Exp Accuracy") +
    xlab("Frequency") +
    #ggtitle("Base Non-Tensed") +
    facet_grid(~model) +
    scale_fill_brewer(palette="PRGn") +
    ylim(0,1) +
    theme(axis.text=element_text(size=10),
          legend.position = "none")
ggsave("./images/argstruct-base-acc.png",height=1.5,width=6)

```

## Passive Context Few Shot Learning

### Test Items

Again, object expectation is the surprisal in the object condition minus the surprisal in the no-object condition. Now, it may be the case that all the model is doing is learning that some verbs can occur in a "was + VERB" context. If so, that's fine. This test is -- in some sense -- a control (the model would fail to generalize for verbs it hasn't seen in the passive context).

  • The gazelle was devoured yesterday . [object]
  
  • The gazelle devoured yesterday . [no-object]
  
Example with transitive verb

  • The gazelle was slept yesterday . [object]
  
  • The gazelle slept yesterday . [no-object]
  
Modifier

  • The gazelle was quickly and rapidly devoured yesterday . [obj]
  
  • The gazelle quickly and rapidly devoured yesterday . [no-obj]
  
Long Modifier

  • The gazelle was quickly , rapidly , and totally devoured yesterday . [obj]
  
  • The gazelle quickly , rapidly , and totally devoured yesterday . [no-obj]
  
We measure the object expectation in the "devoured yesterday ." portion of the sentences. 

Predictions: 

  (1) The object expectation for transitive should be greater than for intransitive verbs.
  
  (2) The object expectation should be positive for transitive verbs (it is more likely to occur with a passive object than without an object)
  
  (3) The object expectation should be negative for intransitive verbs (it is more likely to occur without an object than with a passive object)
  
  (4) Ambitransitive verbs should be in between transitive and intransitive

### Results

Here we have to plot against the frequency in total contexts, becaues (theoretically) intransitive verbs don't occur in passive contexts. (Actually, according to the PTB there are a number of times intransitive verbs occur passivally. I'm investigating this further.)

We see a couple of things:

  • For intransitive verbs: The object expectation stars out positive and becomes negative with more exposure, indicating that the models learn proper transitive behavior with greater exposure. Crucially, the learning rate is slower than for the active contexts. This is because the model has less (or no) exposure for these verbs in passive contexts.
      
  • For transitive verbs: The object expectation starts off postivie, and increases with exposure.
  
  • There is a significant difference between transitive and intransitive after only 2 exposures! Strong evidence of few-shot learning capeabilities
      
  • The ambi-transitive verbs are between transitive and intransitives.

LSTM Baseline:

  • We see no difference between the conditions for the modified sentences. For the no-modifier sentences, we see same pattern of behavior as with the LSTM model.

```{r}
d_agg %>%
  filter(total_freq == "2" | total_freq == "3" | total_freq == "5" | total_freq == "10" | total_freq == "20" | total_freq == "30") %>%
  filter(VBD_obj < 0.1 | VBD_obj > 0.9) %>%
  filter(is_trans != "Ambitrans") %>%
  group_by(model, is_trans, test, vbd_freq) %>%
  filter( test=="transf-nomod" | test == "transf-mod" | test == "transf-longmod") %>%
  
  group_by(model, is_trans, test, total_freq) %>%
    summarise(m = mean(obj_exp),
              s=std.error(obj_exp),
              upper=m+1.96*s,
              lower=m-1.96*s)%>%
  ungroup() %>%
  ggplot(aes(x=total_freq, y=m, ymin=lower, ymax=upper, color=is_trans)) +
    geom_point(stat="identity", position="dodge", size=2) +
    geom_errorbar(width=.2, alpha=0.8) +
    geom_hline(yintercept=0.5, color="blue", alpha=0.5) +
    ylab("Passivizability Expectation") +
    xlab("Frequency in Total Contexts") +
    ggtitle("Argument Structure: Passive Contexts") +
    facet_grid(test ~ model) +
    theme(axis.title.x=element_blank(),
          legend.position = "none")
ggsave("./images/argstruct-transf.png",height=3.5,width=6)

```


```{r}
d_agg %>%
  filter(total_freq == "2" | total_freq == "3" | total_freq == "5" | total_freq == "10" | total_freq == "20" | total_freq == "30") %>%
  filter(VBD_obj < 0.1 | VBD_obj > 0.9) %>%
  filter(is_trans != "Ambitrans") %>%
  group_by(model, is_trans, test, vbd_freq) %>%
  filter( test=="transf-nomod" | test == "transf-mod" | test == "transf-longmod") %>%
  
  mutate(obj_exp = if_else(obj_exp > 0, 1, 0)) %>%
  mutate(obj_exp = if_else(is_trans == "Intrans", 1-obj_exp, obj_exp)) %>%
  
  group_by(model, test, total_freq) %>%
    summarise(m = mean(obj_exp),
              s=std.error(obj_exp),
              upper=m+1.96*s,
              lower=m-1.96*s)%>%
  ungroup() %>%
  ggplot(aes(x=total_freq, y=m, ymin=lower, ymax=upper, fill=model)) +
    geom_bar(stat="identity", position="dodge", size=3) +
    geom_errorbar(position=position_dodge(width=0.9), width=.2, alpha=0.8) +
    geom_hline(yintercept=0.5, color="blue", alpha=0.5) +
    ylab("Passive. Exp. Accuracy") +
    xlab("Frequency") +
    #ggtitle("Base Non-Tensed") +
    facet_grid(test~model) +
    scale_fill_brewer(palette="PRGn") +
    theme(axis.text=element_text(size=10),
          legend.position = "none")
ggsave("./images/argstruct-transf-acc.png",height=3.5,width=6)

```


## Transformations 

SEE VBD_ONLY_ANALYSIS for invarience results!


# Nominal Number Learning

Read in the data. 

```{r}

d_agg = read.csv("number_data.csv") %>%
  mutate(freq_cat = as.factor(freq_cat)) %>%
  mutate(model = factor(model, levels = c("5gram", "lstm", "actionLstm", "rnng"))) %>%
  mutate(test = factor(test, levels = c("base_simple", "base_pp", "base_rc", "transf_simple", "transf_mod")))

```

## Base Context Few Shot Learning

For these results I plot learning against frequency in both base and transformed contexts.

### Test Items

We measure the plural expectation by taking the surprisal at "is" minus the surprisal at "are" for two classes of nouns: Singular nouns (NN) and Plural nouns (NNS)

Base simple

  • The president is [sing]
  
  • The president are [pl]

Base_PP: A nominal distractor of the opposite number

  • The president with the documents is...
  
  • The president with the documents are...
  
Predictions:

  (1) For singular nouns (NN): Negative plural expectation
  
  (2) For plural nouns (NNS): Positive plural expectation
  
  (3) Difference in expectation between NN and NNS

### Results

Simple Condition

  • We find a significant difference between NN and NNS with even one exposure
  
  • We find a positive plural expectation for NNS after two exposures
  
Base_PP Condition

  • We find a significant difference between NN and NNS after two exposures
  
  • The singular expectation grows with exposure for NNS, but is never greater than zero
  
Model Comparison:

  • We see the largest difference between the two conditions with the RNNG

```{r}
d_agg %>%
  drop_na() %>%
  filter(test == "base_pp" | test == "base_simple" | test == "base_rc") %>%
  group_by(model, pos, freq_cat, test) %>%
    summarise(m = mean(pl_exp),
              s=std.error(pl_exp),
              upper=m+1.96*s,
              lower=m-1.96*s)%>%
  ungroup() %>%
  ggplot(aes(x=freq_cat, y=m, ymin=lower, ymax=upper, color=pos)) +
    geom_point(stat="identity", position="dodge", size=2, alpha=1) +
    geom_errorbar(width=.2, alpha=1) +
    geom_hline(yintercept=0, color="blue", alpha=0.5) +
    ylab("Plural Expectation") +
    xlab("Frequency") +
    facet_grid(test ~ model) +
    ggtitle("Number: Base Contexts") +
    theme(axis.title.x=element_blank(),
          legend.position = "none")
ggsave("./images/number-base.png",height=3.5,width=6)


```


```{r}
d_agg %>%
  drop_na() %>%
  filter(test == "base_pp" | test == "base_simple" | test == "base_rc") %>%
  
  mutate(pl_exp = if_else(pl_exp > 0, 1, 0)) %>%
  mutate(pl_exp = if_else(pos == "NN", 1-pl_exp, pl_exp)) %>%
  
  group_by(model, freq_cat, test) %>%
    summarise(m = mean(pl_exp),
              s=std.error(pl_exp),
              upper=m+1.96*s,
              lower=m-1.96*s)%>%
  ungroup() %>%
  ggplot(aes(x=freq_cat, y=m, ymin=lower, ymax=upper, fill=model)) +
    geom_bar(stat="identity", position="dodge", size=3) +
    geom_errorbar(position=position_dodge(width=0.9), width=.2, alpha=0.8) +
    geom_hline(yintercept=0.5, color="blue", alpha=0.5) +
    ylab("Pl Expectation Accuracy") +
    xlab("Frequency") +
    #ggtitle("Base Non-Tensed") +
    facet_grid(test~model) +
    scale_fill_brewer(palette="PRGn") +
    ylim(0,1) +
    theme(axis.text=element_text(size=10),
          legend.position = "none")
ggsave("./images/number-base-acc.png",height=3.5,width=6)


```


## Transformed Context Few Shot Learning

### Test Items

We measure the plural expectation by taking the surprisal difference between the two conditions at the noun. We use singular nouns (NN) and plural nouns (NNS)

Transf_simple:

  • Is/was the president... [sing]
  
  • Are/were the president... [pl]

Transf_mod:

  • Is/was the very big and important president...[sing]
  
  • Are/were the very big and important president... [pl]
  
Predictions:

  (1) For singular nouns (NN): Negative plural expectation
  
  (2) For plural nouns (NNS): Positive plural expectation
  
  (3) Difference in expectation between NN and NNS

### Results

Note: The scale here is *really small*. Because we have so many items the difference is probably significant (I haven't ran the stats yet, but the error bars are tiny). However, the diffence is like 1/5 of a bit of surprisal.

Simple Condition

  • We find a significant difference between NN and NNS after two exposures, except for nouns that occur 3 times in training.
  
  • The NN never has a negative plural expectation.
  
Modifier Condition

  • We find a significant difference between NN and NNS after two exposures, but again for nouns that occur 3 timse the difference does not look significant.
  
  • Again, the plural expectation for NN doesn't really go below zero (except for maybe one bucket)
  
Model Comparison:

  • The RNNG is the only model that, for the simple test, shows positive expectation for plurals and negatie expectation for the singulars.

```{r}
trans_nouns = as.list(read.csv("data/inverted_nouns.txt", sep ="\t", header=FALSE)[2])

intersection = c('threat', 'broker', 'deductibility', 'nameplates', 'businessman', 'listing', 'lobbyist', 'someone', 'desk', 'details', 'lawyer', 'dispute', 'forces', 'hearings', 'creators')

d_agg %>%
  filter(!verb %in% intersection) %>%
  filter(test == "transf_simple" | test == "transf_mod") %>%
  group_by(model, pos, freq_cat, test) %>%
    summarise(m = mean(pl_exp),
              s=std.error(pl_exp),
              upper=m+1.96*s,
              lower=m-1.96*s)%>%
  ungroup() %>%
  ggplot(aes(x=freq_cat, y=m, ymin=lower, ymax=upper, color=pos)) +
    geom_point(stat="identity", position="dodge", size=2) +
    geom_errorbar(width=.2) +
    geom_hline(yintercept=0, color="blue", alpha=0.5) +
    ylab("Plural Expectation") +
    xlab("Frequency") +
    facet_grid(test ~ model) +
    ggtitle("Number: Transformed Contexts") +
    #ylim(-1, 1) +
    theme(axis.title.x=element_blank(),
          legend.position = "none")
ggsave("./images/number-transf.png",height=3.5,width=6)

```
  
```{r}
intersection = c('threat', 'broker', 'deductibility', 'nameplates', 'businessman', 'listing', 'lobbyist', 'someone', 'desk', 'details', 'lawyer', 'dispute', 'forces', 'hearings', 'creators')

d_agg %>%
  filter(!verb %in% intersection) %>%
  filter(test == "transf_simple" | test == "transf_mod") %>%
  
  mutate(pl_exp = if_else(pl_exp > 0, 1, 0)) %>%
  mutate(pl_exp = if_else(pos == "NN", 1-pl_exp, pl_exp)) %>%
  
  group_by(model, freq_cat, test) %>%
    summarise(m = mean(pl_exp),
              s=std.error(pl_exp),
              upper=m+1.96*s,
              lower=m-1.96*s)%>%
  ungroup() %>%
  ggplot(aes(x=freq_cat, y=m, ymin=lower, ymax=upper, fill=model)) +
    geom_bar(stat="identity", position="dodge", size=3) +
    geom_errorbar(position=position_dodge(width=0.9), width=.2, alpha=0.8) +
    geom_hline(yintercept=0.5, color="blue", alpha=0.5) +
    ylab("Pl Expectation Accuracy") +
    xlab("Frequency") +
    #ggtitle("Base Non-Tensed") +
    facet_grid(test~model) +
    ylim(0,1) +
    scale_fill_brewer(palette="PRGn") +
    theme(axis.text=element_text(size=10),
          legend.position = "none")
ggsave("./images/number-transf-acc.png",height=3.5,width=6)


```


