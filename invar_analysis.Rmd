---
title: "Initial Analysis for Few Shot Learning"
output:
  pdf_document:
    latex_engine: xelatex
---

```{r, echo=FALSE}
library(tidyverse)
library(brms)
library(lme4)
library(lmerTest)
library(plotrix)
library(stringr)
library(readxl)
library(RColorBrewer)
library(Hmisc)

options(scipen = 999) 
```


# Verbal Argument Structure



## Stats Tests
```{r}
supervision_test = function(df){
  m1 = glm(acc ~ model, family = binomial, data = df %>% filter(model == "rnng" | model == "lstm") )
  m2 = glm(acc ~ model, family = binomial, data = df %>% filter(model == "actionLstm" | model == "lstm") )
  df = df %>%
    summarise(e_rnng = round(coef(summary(m1))[2], 5),
              p_rnng = round(coef(summary(m1))[8], 5),
              e_action = round(coef(summary(m2))[2], 5),
              p_action = round(coef(summary(m2))[8], 5))
}


exposure_test = function(df){
  m = glm(acc ~ freq_cat, family = binomial, data = df)
  df = df %>% summarise( e = coef(summary(m))[2],
                         p = coef(summary(m))[8])
}

fewshot_test = function(df){
  #print(unique(df$test))
  #print(unique(df$freq_cat))
  
  ngram_acc = df %>% filter(model=="5gram") %>% select(acc) %>% as_vector()

  t.ngram = binom.test(sum(ngram_acc), length(ngram_acc), p = 0.5, alternative="greater")$p.value
  lstm_acc = df %>% filter(model=="lstm") %>% select(acc) %>% as_vector()
  t.lstm = binom.test(sum(lstm_acc), length(lstm_acc), p = 0.5, alternative="greater")$p.value
  action_acc = df %>% filter(model=="actionLstm") %>% select(acc) %>% as_vector()
  t.action = binom.test(sum(action_acc), length(action_acc), p = 0.5, alternative="greater")$p.value
  rnng_acc = df %>% filter(model=="rnng") %>% select(acc) %>% as_vector()
  t.rnng = binom.test(sum(rnng_acc), length(rnng_acc), p = 0.5, alternative="greater")$p.value

  m1 = glm(acc ~ model, family = binomial, data = df %>% filter(model == "lstm" | model == "5gram") )
  m2 = glm(acc ~ model, family = binomial, data = df %>% filter(model == "actionLstm" | model == "5gram") )
  m3 = glm(acc ~ model, family = binomial, data = df %>% filter(model == "rnng" | model == "5gram") )

  df = df %>%
    summarise(t.ngram = round(t.ngram, 5), t.lstm = round(t.lstm,5), t.action = round(t.action,5), t.rnng = round(t.rnng,5))
              #e_lstm = round(coef(summary(m1))[2], 5),
              #p_lstm = round(coef(summary(m1))[8], 5),
              #e_action = round(coef(summary(m2))[2], 5),
              #p_action = round(coef(summary(m2))[8], 5),
              #e_rnng = round(coef(summary(m3))[2], 5),
              #p_rnng = round(coef(summary(m3))[8], 5)),
  return(df)
}


```


```{r}
plot_accs = function(df_raw, df_summary, filename, h, w, ylims){
  
  ggplot() +
    theme_bw()+
    stat_smooth(geom = "line", data = df_raw, aes(x=log10(freq_cat), y=acc, color=model), method = 'glm', method.args = list(family = "binomial"), size = 1, alpha=0.5) +
    stat_smooth(data = df_raw, aes(x=log10(freq_cat), y=acc, color=model), method = 'glm', method.args = list(family = "binomial"), size = 0, alpha=0.2) +
  
    geom_point(data = df_summary, aes(x=freq_cat, y=m, color = model, fill=model), stat="identity", position="dodge", size=2) +
    geom_errorbar(data = df_summary, aes(x=freq_cat, ymin=lower, ymax=upper, color = model), width=0.1, alpha=0.8) +
    geom_hline(yintercept=0.5, color="blue", alpha=0.5) +
    facet_grid(~test) +
    coord_cartesian(ylim=ylims) +
    theme(axis.text=element_text(size=10),
          legend.position = "bottom", 
          panel.grid.minor = element_blank())
ggsave(filename,height=h,width=w)

}

```


### Read in the data
```{r}

d_agg = read.csv("argstruct_data.csv") %>%
  mutate(vb_freq = as.factor(vb_freq),
         vbd_freq = as.factor(vbd_freq),
         total_freq = as.factor(total_freq)) %>%
  mutate(model = factor(model, levels = c("5gram", "lstm", "actionLstm", "rnng"))) %>%
  mutate(acc = if_else(obj_exp > 0, 1, 0),
         acc = if_else(is_trans == "Intrans", 1-acc, acc)) %>%
  filter(is_trans != "Ambitrans")



```


#### Base-Present
```{r}
d_arg_base_pres = d_agg %>%
  filter(test == "base-pres" & is_trans != "Ambitrans") %>%
  mutate(freq_cat = vb_freq) %>%
  mutate(freq_cat = as.numeric(as.character(freq_cat)))

d_arg_base_pres_summary = d_arg_base_pres %>%
  mutate(freq_cat = log10(freq_cat)) %>%
  group_by(model, freq_cat, test) %>%
     summarise(m = mean(acc),
              upper = binconf(sum(acc), n())[2],
              lower = binconf(sum(acc), n())[3])%>%
  ungroup()

plot_accs(d_arg_base_pres, d_arg_base_pres_summary, "./images/arg_base_pres.pdf", 5, 3, c(0, 1))


```

Statistics
```{r}
# Fewshot Learning
d_arg_base_pres %>%
  group_by(test, freq_cat) %>% do({fewshot_test(.)}) %>% ungroup() %>%
arrange(test) %>%
gather(model, p, c(t.ngram, t.lstm, t.action, t.rnng)) %>% group_by(test, model) %>% filter(p<0.05) %>% summarise(n = n())

d_arg_base_pres %>%
  group_by(test, model) %>% do({exposure_test(.)}) %>% ungroup()

# Structural supervision
d_arg_base_pres %>%
  group_by(test) %>% do({ supervision_test(.)}) %>% ungroup() %>%
arrange(test)
 
```


#### Base-Past
```{r expecation, eval = False}
d_arg_base_past = d_agg %>%
  filter(test == "base-nomod" & is_trans != "Ambitrans") %>%
  mutate(freq_cat = vbd_freq) %>%
  mutate(freq_cat = as.numeric(as.character(freq_cat)))

  
d_arg_base_past_summary = d_arg_base_past %>%
  mutate(freq_cat = log10(freq_cat)) %>%
  group_by(model, freq_cat, test) %>%
     summarise(m = mean(acc),
              upper = binconf(sum(acc), n())[2],
              lower = binconf(sum(acc), n())[3])%>%
  ungroup()

plot_accs(d_arg_base_past, d_arg_base_past_summary, "./images/arg_base_past.pdf", 5, 3, c(0, 1))

```
### Statistics
```{r}
# Fewshot Learning
d_arg_base_past %>%
  group_by(test, freq_cat) %>% do({fewshot_test(.)}) %>% ungroup() %>%
arrange(test, freq_cat) %>%
gather(model, p, c(t.ngram, t.lstm, t.action, t.rnng)) %>% group_by(test, model) %>% filter(p<0.05) %>% summarise(n = n())

d_arg_base_past %>%
  group_by(test, model) %>% do({exposure_test(.)}) %>% ungroup()

# Structural supervision
d_arg_base_past %>%
  group_by(test) %>% do({ supervision_test(.)}) %>% ungroup() %>%
arrange(test)
 
```


## Passive Context Few Shot Learning


```{r, Expectation, eval = False}

d_arg_transf = d_agg %>%
  filter( test=="transf-nomod" | test == "transf-mod" | test == "transf-longmod") %>%
  mutate(freq_cat = vbd_freq) %>%
  mutate(freq_cat = as.numeric(as.character(freq_cat))+1 )

d_arg_transf_summary = d_arg_transf %>%
  mutate(freq_cat = log10(freq_cat)) %>%
  group_by(model, freq_cat, test) %>%
    summarise(m = mean(acc),
              upper = binconf(sum(acc), n())[2],
              lower = binconf(sum(acc), n())[3])%>%
  ungroup()

plot_accs(d_arg_transf, d_arg_transf_summary, "./images/arg_transf.pdf", 5, 6, c(0, 1))

```

### Statistics
```{r}

# Fewshot Learning
d_arg_transf %>%
  group_by(test, freq_cat) %>% do({fewshot_test(.)}) %>% ungroup() %>%
arrange(test, freq_cat)%>%
gather(model, p, c(t.ngram, t.lstm, t.action, t.rnng)) %>% group_by(test, model) %>% filter(p<0.05) %>% summarise(n = n())

d_arg_transf %>%
  group_by(test, model) %>% do({exposure_test(.)}) %>% ungroup()

# Structural supervision
d_arg_transf %>%
  group_by(test) %>% do({ supervision_test(.)}) %>% ungroup() %>%
arrange(test)
 
 
```

## Transformation & Invarience

```{r}
d_agg = read.csv("./arg_transf.csv") %>%
  mutate(acc = if_else(obj_exp > 0, 1, 0)) %>%
  mutate(acc = if_else(is_trans == "Intrans", 1-acc, acc)) %>%
  filter(is_trans != "Ambitrans")

arg_transf_invar = d_agg %>%
  mutate(freq_cat = as.factor(vbd_freq)) %>%
  mutate(freq_cat = as.numeric(as.character(freq_cat)))

arg_transf_invar_summary =  arg_transf_invar%>%
  mutate(freq_cat = log10(freq_cat)) %>%
  group_by(model, freq_cat, test) %>%
     summarise(m = mean(acc),
              upper = binconf(sum(acc), n())[2],
              lower = binconf(sum(acc), n())[3])%>%
  ungroup()

plot_accs(arg_transf_invar, arg_transf_invar_summary, "./images/arg_transf_invar.pdf", 5, 6, c(0, 1))

```

### Statistics
```{r}
# Fewshot Learning
arg_transf_invar %>%
  group_by(test, freq_cat) %>% do({fewshot_test(.)}) %>% ungroup() %>%
arrange(test, freq_cat)%>%
gather(model, p, c(t.ngram, t.lstm, t.action, t.rnng)) %>% group_by(test, model) %>% filter(p<0.05) %>% summarise(n = n())

arg_transf_invar %>%
  group_by(test, model) %>% do({exposure_test(.)}) %>% ungroup()

# Structural supervision
arg_transf_invar %>%
  group_by(test) %>% do({ supervision_test(.)}) %>% ungroup() %>%
arrange(test)
 
 
 
```

# Nominal Number Learning

Read in the data. 

```{r}

d_agg = read.csv("number_data.csv") %>%
  mutate(freq_cat = as.factor(freq_cat)) %>%
  mutate(model = factor(model, levels = c("5gram", "lstm", "actionLstm", "rnng"))) %>%
  mutate(test = factor(test, levels = c("base_simple", "base_pp", "base_rc", "transf_simple", "transf_mod")))

```


## Base Context Few Shot Learning

```{r}
d_num_base_acc = d_agg %>%
  drop_na() %>%
  filter(test == "base_pp" | test == "base_simple" | test == "base_rc") %>%
  mutate(acc = if_else(pl_exp > 0, 1, 0)) %>%
  mutate(acc = if_else(pos == "NN", 1-acc, acc)) %>%
  mutate(freq_cat = as.numeric(as.character(freq_cat)))

d_num_base_acc_summary = d_num_base_acc %>%
  mutate(freq_cat = log10(freq_cat)) %>%
  group_by(model, freq_cat, test) %>%
    summarise(m = mean(acc),
              upper = binconf(sum(acc), n())[2],
              lower = binconf(sum(acc), n())[3])%>%
  ungroup()

plot_accs(d_num_base_acc, d_num_base_acc_summary, "./images/number-base.pdf", 5, 6, c(0.4, 0.9))


```
### Statistics
```{r}
# Exposure learning
d_num_base_acc %>%
  group_by(test, freq_cat) %>% do({fewshot_test(.)}) %>% ungroup() %>%
arrange(test, freq_cat) %>%
gather(model, p, c(t.ngram, t.lstm, t.action, t.rnng)) %>% group_by(test, model) %>% filter(p<0.05) %>% summarise(n = n())

d_num_base_acc %>%
  group_by(test, model) %>% do({exposure_test(.)}) %>% ungroup()

# Structural supervision
d_num_base_acc %>%
  group_by(test) %>% do({ supervision_test(.)}) %>% ungroup() %>%
arrange(test)
```



## Transformed Context Few Shot Learning

```{r}
intersection = c('threat', 'broker', 'deductibility', 'nameplates', 'businessman', 'listing', 'lobbyist', 'someone', 'desk', 'details', 'lawyer', 'dispute', 'forces', 'hearings', 'creators')

d_num_transf_acc = d_agg %>%
  filter(!verb %in% intersection) %>%
  filter(test == "transf_simple" | test == "transf_mod") %>%
  mutate(acc = if_else(pl_exp > 0, 1, 0)) %>%
  mutate(acc = if_else(pos == "NN", 1-acc, acc)) %>%
  mutate(freq_cat = as.numeric(as.character(freq_cat)))

  
d_num_transf_acc_summary = d_num_transf_acc %>%
  mutate(freq_cat = log10(freq_cat)) %>%
  group_by(model, freq_cat, test) %>%
     summarise(m = mean(acc),
              upper = binconf(sum(acc), n())[2],
              lower = binconf(sum(acc), n())[3])%>%
  ungroup()

plot_accs(d_num_transf_acc, d_num_transf_acc_summary, "./images/number-transf.pdf", 5, 6, c(0.4, 0.9))


```

### Statistics
```{r}

# Few-shot Learning
d_num_transf_acc %>%
  group_by(test, freq_cat) %>% do({fewshot_test(.)}) %>% ungroup() %>%
arrange(test, freq_cat) %>%
gather(model, p, c(t.ngram, t.lstm, t.action, t.rnng)) %>% group_by(test, model) %>% filter(p<0.05) %>% summarise(n = n())

d_num_transf_acc %>%
  group_by(test, model) %>% do({exposure_test(.)}) %>% ungroup()
  
# Structural supervision
d_num_transf_acc %>%
  group_by(test) %>% do({ supervision_test(.)}) %>% ungroup() %>%
arrange(test)
 
```

